name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build releases
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Build releases with documentation
      run: |
        mkdir -p releases temp
        
        # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        create_release() {
          local os=$1
          local arch=$2
          local ext=$3
          local name="ai-bot-$os-$arch"
          local temp_dir="temp/$name"
          
          echo "Building $name..."
          mkdir -p "$temp_dir"
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸Ðº
          GOOS=$os GOARCH=$arch go build -ldflags "-s -w" -o "$temp_dir/ai-bot$ext" .
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
          cp README.md "$temp_dir/" 2>/dev/null || true
          cp USAGE.md "$temp_dir/" 2>/dev/null || true
          cp .env.example "$temp_dir/" 2>/dev/null || true
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ install ÑÐºÑ€Ð¸Ð¿Ñ‚
          if [[ "$os" == "windows" ]]; then
            cat > "$temp_dir/install.bat" << 'EOF'
        @echo off
        echo ðŸ¤– AI Bot Installation
        echo ======================
        echo.
        echo âœ… AI Bot Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ!
        echo.
        echo Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚:
        echo   ai-bot.exe --config  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
        echo   ai-bot.exe           # Ð—Ð°Ð¿ÑƒÑÐº
        echo.
        pause
        EOF
          else
            cat > "$temp_dir/install.sh" << 'EOF'
        #!/bin/bash
        # AI Bot Installation Script
        
        echo "ðŸ¤– AI Bot Installation"
        echo "======================"
        echo ""
        
        # Ð”ÐµÐ»Ð°ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
        chmod +x ./ai-bot
        
        echo "âœ… AI Bot ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
        echo ""
        echo "Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚:"
        echo "  ./ai-bot --config  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°"
        echo "  ./ai-bot           # Ð—Ð°Ð¿ÑƒÑÐº"
        echo ""
        EOF
            chmod +x "$temp_dir/install.sh"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
          if [[ "$os" == "windows" ]]; then
            (cd "$temp_dir" && zip -r "../../releases/$name.zip" .)
          else
            tar -czf "releases/$name.tar.gz" -C temp "$name"
          fi
        }
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
        create_release "windows" "amd64" ".exe"
        create_release "windows" "386" ".exe"
        create_release "linux" "amd64" ""
        create_release "linux" "386" ""
        create_release "linux" "arm64" ""
        create_release "freebsd" "amd64" ""
        create_release "freebsd" "386" ""
        create_release "darwin" "amd64" ""
        create_release "darwin" "arm64" ""
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        ls -la releases/
        
    - name: Generate checksums and release info
      run: |
        cd releases
        sha256sum *.zip *.tar.gz > checksums.txt
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        cat > README.txt << 'EOF'
        # AI Bot Release Files
        
        ## ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹:
        
        ### Windows
        - **ai-bot-windows-amd64.zip** - Windows 64-bit (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
        - **ai-bot-windows-386.zip** - Windows 32-bit
        
        ### Linux
        - **ai-bot-linux-amd64.tar.gz** - Linux 64-bit (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
        - **ai-bot-linux-386.tar.gz** - Linux 32-bit
        - **ai-bot-linux-arm64.tar.gz** - Linux ARM64 (Raspberry Pi 4+)
        
        ### FreeBSD
        - **ai-bot-freebsd-amd64.tar.gz** - FreeBSD 64-bit
        - **ai-bot-freebsd-386.tar.gz** - FreeBSD 32-bit
        
        ### macOS
        - **ai-bot-darwin-amd64.tar.gz** - macOS Intel
        - **ai-bot-darwin-arm64.tar.gz** - macOS Apple Silicon (M1/M2/M3)
        
        ## ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº:
        
        ### Windows:
        1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ ai-bot-windows-amd64.zip
        2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²
        3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ install.bat Ð¸Ð»Ð¸:
           ```cmd
           ai-bot.exe --config
           ai-bot.exe
           ```
        
        ### Linux/macOS/FreeBSD:
        1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
        2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ: `tar -xzf ai-bot-*.tar.gz`
        3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: `./install.sh` Ð¸Ð»Ð¸:
           ```bash
           chmod +x ai-bot
           ./ai-bot --config
           ./ai-bot
           ```
        
        ## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸:
        
        ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ðµ ÑÑƒÐ¼Ð¼Ñ‹:
        ```bash
        sha256sum -c checksums.txt
        ```
        
        ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð°Ñ€Ñ…Ð¸Ð² ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚:
        - Ð˜ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ai-bot
        - README.md - Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
        - USAGE.md - Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ
        - .env.example - Ð¿Ñ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
        - install ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
        EOF
        
        echo "Generated files:"
        ls -la
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: AI Bot ${{ steps.version.outputs.VERSION }}
        body: |
          ## AI Bot ${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€ÐµÐ»Ð¸Ð·:
          
          **Windows:**
          - [ai-bot-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-windows-amd64.zip) - Windows 64-bit (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
          - [ai-bot-windows-386.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-windows-386.zip) - Windows 32-bit
          
          **Linux:**
          - [ai-bot-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-linux-amd64.tar.gz) - Linux 64-bit (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
          - [ai-bot-linux-386.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-linux-386.tar.gz) - Linux 32-bit
          - [ai-bot-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-linux-arm64.tar.gz) - Linux ARM64 (Raspberry Pi 4+)
          
          **FreeBSD:**
          - [ai-bot-freebsd-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-freebsd-amd64.tar.gz) - FreeBSD 64-bit
          - [ai-bot-freebsd-386.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-freebsd-386.tar.gz) - FreeBSD 32-bit
          
          **macOS:**
          - [ai-bot-darwin-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-darwin-amd64.tar.gz) - macOS Intel
          - [ai-bot-darwin-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ai-bot-darwin-arm64.tar.gz) - macOS Apple Silicon (M1/M2/M3)
          
          ### ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚:
          
          #### Windows:
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ ai-bot-windows-amd64.zip
          2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²
          3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ install.bat Ð¸Ð»Ð¸:
             ```cmd
             ai-bot.exe --config
             ai-bot.exe
             ```
          
          #### Linux/macOS/FreeBSD:
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
          2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ: `tar -xzf ai-bot-*.tar.gz`
          3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: `./install.sh` Ð¸Ð»Ð¸:
             ```bash
             chmod +x ai-bot
             ./ai-bot --config
             ./ai-bot
             ```
          
          ### ðŸ“‹ Ð§Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð² ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð°Ñ€Ñ…Ð¸Ð²:
          
          - **ai-bot** - Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          - **README.md** - Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
          - **USAGE.md** - Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ
          - **.env.example** - Ð¿Ñ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
          - **install** ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
          
          ### ðŸ” ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ðµ ÑÑƒÐ¼Ð¼Ñ‹:
          
          ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ [checksums.txt](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/checksums.txt)
          
          ```bash
          sha256sum -c checksums.txt
          ```
        files: |
          releases/*.zip
          releases/*.tar.gz
          releases/checksums.txt
          releases/README.txt
        draft: false
        prerelease: false
